<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <preConditions>
        <dbms type="postgresql"/>
    </preConditions>

    <include file="db-migrate-changelog-from-flyway.xml" />
    <include file="db-migrate-from-flyway.xml" />

    <changeSet id="20190614 topic_resource_types" author="janespen">
        <createTable tableName="topic_resource_type">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="topic_resource_type_public_id" /></column>
            <column name="topic_id" type="integer"><constraints referencedTableName="topic" referencedColumnNames="id" foreignKeyName="resource_type_topic_id_fkey"/></column>
            <column name="resource_type_id" type="integer"><constraints referencedTableName="resource_type" referencedColumnNames="id" foreignKeyName="topic_resource_type_id_fkey"/></column>
        </createTable>
        <addUniqueConstraint tableName="topic_resource_type" columnNames="topic_id,resource_type_id" constraintName="topic_resource_type_unique" />
    </changeSet>

    <changeSet id="20190622 create topic_tree_by_subject_id_view view" author="Jon-Eirik Pettersen">
        <!-- Modified query from old code migrated to a view for usage in queries -->
        <createView viewName="topic_tree_by_subject_id_view" replaceIfExists="true">
            WITH RECURSIVE topic_tree(topic_id, connection_id, parent_topic_id, topic_rank, topic_level, subject_id) AS
            (

            SELECT st.topic_id, 0 AS connection_id, 0 AS parent_topic_id, st.rank AS topic_rank, 0 AS topic_level,
            st.subject_id AS subject_id
            FROM subject_topic st

            UNION ALL

            SELECT ts.subtopic_id, ts.id AS connection_id, ts.topic_id, ts."rank" as topic_rank, topic_level + 1,
            topic_tree.subject_id subject_id
            FROM topic_subtopic ts
            INNER JOIN topic_tree ON ts.topic_id = topic_tree.topic_id)
            SELECT topic_tree.* FROM topic_tree
            ORDER BY topic_level;
        </createView>
    </changeSet>
    <changeSet id="20190623 create topic_tree_by_topic_id_view view" author="Jon-Eirik Pettersen">
        <createView viewName="topic_tree_by_topic_id_view" replaceIfExists="true">
            WITH RECURSIVE topic_tree(root_topic_id, topic_id, parent_topic_id, topic_rank, topic_level) AS (
            SELECT ts_one.topic_id, ts_one.topic_id, 0 AS parent_topic_id, ts_one.rank AS topic_rank, 0 AS topic_level
            FROM topic_subtopic ts_one
            UNION ALL
            SELECT topic_tree.root_topic_id, ts_next.subtopic_id, ts_next.topic_id, ts_next.rank AS topic_rank,
            topic_level + 1
            FROM topic_subtopic ts_next
            INNER JOIN topic_tree on ts_next.topic_id = topic_tree.topic_id)
            SELECT CONCAT(root_topic_id, '-', parent_topic_id, '-', topic_id) AS id, root_topic_id, topic_id,
            parent_topic_id, MIN(topic_rank) AS topic_rank, MIN(topic_level) AS topic_level FROM topic_tree GROUP BY
            root_topic_id,topic_id,parent_topic_id;
        </createView>
    </changeSet>
    <changeSet id="20190731 path aliases" author="janespen">
        <createTable tableName="path_alias">
            <column name="id" type="serial">
                <constraints primaryKey="true" />
            </column>
            <column name="alias" type="varchar(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uniq_path_alias" />
            </column>
            <column name="orig_path" type="clob"/>
            <column name="root" type="varchar(255)"/>
            <column name="leaf" type="varchar(255)"/>
            <column name="created" type="datetime"/>
            <column name="replaced" type="integer">
                <constraints referencedTableName="path_alias" referencedColumnNames="id" foreignKeyName="fk_path_alias_replaced"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>