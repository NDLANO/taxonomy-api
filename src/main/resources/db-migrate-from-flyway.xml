<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="20190605 v1 create subject table" author="Migrated From Flyway">
        <createTable tableName="subject">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="subject_public_id"/></column>
            <column name="name" type="varchar(255)" />
        </createTable>
    </changeSet>
    <changeSet id="20190605 v2 create topic table" author="Migrated From Flyway">
        <createTable tableName="topic">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="topic_public_id"/></column>
            <column name="name" type="varchar(255)" />
        </createTable>
    </changeSet>
    <changeSet id="20190605 v3 create subject_topic_table" author="Migrated From Flyway">
        <createTable tableName="subject_topic">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="subject_topic_public_id" /></column>
            <column name="topic_id" type="integer"><constraints referencedTableName="topic" referencedColumnNames="id" foreignKeyName="subject_topic_topic_id_fkey"/></column>
            <column name="subject_id" type="integer"><constraints referencedTableName="subject" referencedColumnNames="id" foreignKeyName="subject_topic_subject_id_fkey"/></column>
            <column name="is_primary" type="boolean" />
        </createTable>
        <addUniqueConstraint tableName="subject_topic" columnNames="topic_id,subject_id" constraintName="subject_topic_unique" />
    </changeSet>
    <changeSet id="20190605 v4 create topic_subtopic table" author="Migrated From Flyway">
        <createTable tableName="topic_subtopic">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="topic_subtopic_public_id" /></column>
            <column name="topic_id" type="integer"><constraints referencedTableName="topic" referencedColumnNames="id" foreignKeyName="topic_subtopic_topic_id_fkey"/></column>
            <column name="subtopic_id" type="integer"><constraints referencedTableName="topic" referencedColumnNames="id" foreignKeyName="topic_subtopic_subtopic_id_fkey"/></column>
            <column name="is_primary" type="boolean" />
        </createTable>
        <addUniqueConstraint tableName="subject_topic" columnNames="topic_id,subject_id" constraintName="topic_subtopic_unique" />
    </changeSet>
    <changeSet id="20190605 v5 create resource table" author="Migrated From Flyway">
        <createTable tableName="resource">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="resource_public_id"/></column>
            <column name="name" type="varchar(255)" />
        </createTable>
    </changeSet>
    <changeSet id="20190605 v6 create topic_resource table" author="Migrated From Flyway">
        <!--
            This migration used to create foreign key topic_resource_topic_id_fkey with name topic_resource_topic_id_fkey, but H2 refuses to have two foreign keys with the
            same name on different tables, so it had to be changed, next migration will fix it for environments that actually created it with the wrong name (environments
            created after flyway migration)
        -->

        <validCheckSum>8:7841f9bb089c1c742715d09a5ece2926</validCheckSum>
        <createTable tableName="topic_resource">
            <column name="id" type="serial">
                <constraints primaryKey="true"/>
            </column>
            <column name="public_id" type="varchar(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="topic_resource_public_id"/>
            </column>
            <column name="topic_id" type="integer">
                <constraints referencedTableName="topic" referencedColumnNames="id"
                             foreignKeyName="topic_resource_topic_id_fkey"/>
            </column>
            <column name="resource_id" type="integer">
                <constraints referencedTableName="resource" referencedColumnNames="id"
                             foreignKeyName="topic_resource_resource_id_fkey"/>
            </column>
            <column name="is_primary" type="boolean"/>
        </createTable>
        <addUniqueConstraint tableName="topic_resource" columnNames="topic_id,resource_id"
                             constraintName="topic_resource_unique"/>
    </changeSet>

    <changeSet id="20200508 re-create topic_resource_topic_id_fkey foreign key with correct name"
               author="Jon-Eirik Pettersen">
        <validCheckSum>8:4908b10427b21a67e4a31e11bb781769</validCheckSum>
        <sql>
            ALTER TABLE topic_resource DROP CONSTRAINT IF EXISTS subject_topic_topic_id_fkey;
            ALTER TABLE topic_resource DROP CONSTRAINT IF EXISTS topic_resource_topic_id_fkey;
        </sql>

        <addForeignKeyConstraint baseTableName="topic_resource"
                                 baseColumnNames="topic_id"
                                 constraintName="topic_resource_topic_id_fkey" referencedTableName="topic"
                                 referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="20190605 v7 create resource_type table" author="Migrated From Flyway">
        <createTable tableName="resource_type">
            <column name="id" type="serial">
                <constraints primaryKey="true"/>
            </column>
            <column name="parent_id" type="integer">
                <constraints referencedTableName="resource_type" referencedColumnNames="id"
                             foreignKeyName="resource_type_parent_id_fkey"/>
            </column>
            <column name="public_id" type="varchar(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="resource_type_public_id"/>
            </column>
            <column name="name" type="varchar(255)"/>
        </createTable>
    </changeSet>
    <changeSet id="20190605 v8 create resource_resource_type table" author="Migrated From Flyway">
        <createTable tableName="resource_resource_type">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="resource_resource_type_public_id" /></column>
            <column name="resource_id" type="integer"><constraints referencedTableName="resource" referencedColumnNames="id" foreignKeyName="resource_type_resource_id_fkey"/></column>
            <column name="resource_type_id" type="integer"><constraints referencedTableName="resource_type" referencedColumnNames="id" foreignKeyName="resource_type_resource_type_id_fkey"/></column>
        </createTable>
        <addUniqueConstraint tableName="resource_resource_type" columnNames="resource_id,resource_type_id" constraintName="resource_resource_type_unique" />
    </changeSet>
    <changeSet id="20190605 v9 add content_uri" author="Migrated From Flyway">
        <addColumn tableName="subject">
            <column name="content_uri" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="topic">
            <column name="content_uri" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="resource">
            <column name="content_uri" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="20190605 v10 language" author="Migrated From Flyway">
        <createTable tableName="subject_translation">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="subject_id" type="integer"><constraints nullable="false" referencedTableName="subject" referencedColumnNames="id" foreignKeyName="subject_translation_subject_id_fkey" /></column>
            <column name="language_code" type="varchar(3)"><constraints nullable="false" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint tableName="subject_translation" columnNames="subject_id,language_code" constraintName="subject_language_unique" />

        <createTable tableName="topic_translation">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="topic_id" type="integer"><constraints nullable="false" referencedTableName="topic" referencedColumnNames="id" foreignKeyName="topic_translation_topic_id_fkey" /></column>
            <column name="language_code" type="varchar(3)"><constraints nullable="false" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint tableName="topic_translation" columnNames="topic_id,language_code" constraintName="topic_language_unique" />

        <createTable tableName="resource_translation">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="resource_id" type="integer"><constraints nullable="false" referencedTableName="resource" referencedColumnNames="id" foreignKeyName="resource_translation_resource_id_fkey" /></column>
            <column name="language_code" type="varchar(3)"><constraints nullable="false" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint tableName="resource_translation" columnNames="resource_id,language_code" constraintName="resource_language_unique" />

        <createTable tableName="resource_type_translation">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="resource_type_id" type="integer"><constraints nullable="false" referencedTableName="resource_type" referencedColumnNames="id" foreignKeyName="resource_type_translation_resource_type_id_fkey" /></column>
            <column name="language_code" type="varchar(3)"><constraints nullable="false" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint tableName="resource_type_translation" columnNames="resource_type_id,language_code" constraintName="resource_type_language_unique" />
    </changeSet>

    <changeSet id="20190605 v11 set primary" author="Migrated From Flyway">
        <validCheckSum>8:b97137a5b271410906d28e86af610f9d</validCheckSum>
        <sql>
            UPDATE subject_topic
            SET is_primary = TRUE
                WHERE id IN (
                    SELECT min(id) AS id
                        FROM subject_topic
                        WHERE topic_id NOT IN (
                            SELECT topic_id
                                FROM subject_topic
                                WHERE is_primary = TRUE
                        )
                        GROUP BY topic_id
                );

            UPDATE topic_subtopic
            SET is_primary = TRUE
                WHERE id IN (
                    SELECT min(id) AS id
                        FROM topic_subtopic
                        WHERE subtopic_id NOT IN (
                            SELECT subtopic_id
                            FROM topic_subtopic
                            WHERE is_primary = TRUE
                        )
                        GROUP BY subtopic_id
                );

            UPDATE topic_resource
            SET is_primary = TRUE
                WHERE id IN (
                    SELECT min(id) AS id
                        FROM topic_resource
                        WHERE resource_id NOT IN (
                            SELECT resource_id
                            FROM topic_resource
                            WHERE is_primary = TRUE
                        )
                        GROUP BY resource_id
                );
        </sql>
    </changeSet>

    <changeSet id="20190605 v12 urls" author="Migrated From Flyway">
        <createTable tableName="cached_url">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)" />
            <column name="path" type="varchar(255)"><constraints nullable="false" /></column>
            <column name="is_primary" type="boolean" />
        </createTable>
    </changeSet>

    <changeSet id="20190605 v13 filter" author="Migrated From Flyway">
        <createTable tableName="filter">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="filter_public_id" /></column>
            <column name="subject_id" type="integer"><constraints referencedTableName="subject" referencedColumnNames="id" foreignKeyName="filter_subject_id_fkey" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>

        <createTable tableName="filter_translation">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="filter_id" type="integer"><constraints nullable="false" referencedTableName="filter" referencedColumnNames="id" foreignKeyName="filter_translation_filter_id_fkey" /></column>
            <column name="language_code" type="varchar(3)"><constraints nullable="false" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>
    </changeSet>

    <changeSet id="20190605 v14 resource_filter" author="Migrated From Flyway">
        <validCheckSum>8:8443ad1a262444b09395879a5c673232</validCheckSum>
        <createTable tableName="relevance">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="relevance_public_id" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>
        <sql>
            INSERT INTO relevance (id, public_id, name) VALUES (1, 'urn:relevance:core', 'Kjernestoff');
            INSERT INTO relevance (id, public_id, name) VALUES (2, 'urn:relevance:supplementary', 'Tilleggstoff');
            ALTER SEQUENCE relevance_id_seq RESTART WITH 3;
        </sql>

        <createTable tableName="relevance_translation">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="relevance_id" type="integer"><constraints nullable="false" /></column>
            <column name="language_code" type="varchar(3)"><constraints nullable="false" /></column>
            <column name="name" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint tableName="relevance_translation" columnNames="relevance_id,language_code" constraintName="relevance_language_unique" />
        <sql>
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (1, 'nb', 'Kjernestoff');
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (1, 'nn', 'Kjernestoff');
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (1, 'en', 'Core content');
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (1, 'se', 'Guovddášávnnas');
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (2, 'nb', 'Tilleggsstoff');
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (2, 'nn', 'Tilleggsstoff');
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (2, 'en', 'Supplementary content');
            INSERT INTO relevance_translation (relevance_id, language_code, name) VALUES (2, 'se', 'Lassiávnnas');
        </sql>

        <createTable tableName="resource_filter">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" unique="true" uniqueConstraintName="resource_filter_public_id" /></column>
            <column name="resource_id" type="integer"><constraints referencedTableName="resource" referencedColumnNames="id" foreignKeyName="resource_filter_resource_id_fkey" /></column>
            <column name="filter_id" type="integer"><constraints referencedTableName="filter" referencedColumnNames="id" foreignKeyName="resource_filter_filter_id_fkey" /></column>
            <column name="relevance_id" type="integer"><constraints referencedTableName="relevance" referencedColumnNames="id" foreignKeyName="resource_filter_relevance_id_fkey" /></column>
        </createTable>
        <addUniqueConstraint tableName="resource_filter" columnNames="filter_id,resource_id" constraintName="resource_filter_unique" />
    </changeSet>

    <changeSet id="20190606 v15 topic_filter" author="Migrated From Flyway">
        <createTable tableName="topic_filter">
            <column name="id" type="serial"><constraints primaryKey="true" /></column>
            <column name="public_id" type="varchar(255)"><constraints nullable="false" uniqueConstraintName="topic_filter_public_id" unique="true"/></column>
            <column name="topic_id" type="integer"><constraints referencedTableName="topic" referencedColumnNames="id" foreignKeyName="topic_filter_topic_id_fkey" /></column>
            <column name="filter_id" type="integer"><constraints referencedTableName="filter" referencedColumnNames="id" foreignKeyName="topic_filter_filter_id_fkey" /></column>
            <column name="relevance_id" type="integer"><constraints referencedTableName="relevance" referencedColumnNames="id" foreignKeyName="topic_filter_relevance_id_fkey" /></column>
        </createTable>
        <addUniqueConstraint tableName="topic_filter" columnNames="filter_id,topic_id" constraintName="topic_filter_unique" />
    </changeSet>

    <changeSet id="20190606 v16 rank" author="Migrated From Flyway">
        <addColumn tableName="topic_resource">
            <column name="rank" type="integer" defaultValueNumeric="0"><constraints nullable="false" /></column>
        </addColumn>
        <addColumn tableName="topic_subtopic">
            <column name="rank" type="integer" defaultValueNumeric="0"><constraints nullable="false" /></column>
        </addColumn>
        <addColumn tableName="subject_topic">
            <column name="rank" type="integer" defaultValueNumeric="0"><constraints nullable="false" /></column>
        </addColumn>
    </changeSet>

    <changeSet id="20190606 v17 add context to topic" author="Migrated From Flyway">
        <addColumn tableName="topic">
            <column name="context" type="boolean" defaultValueBoolean="false"><constraints nullable="false" /></column>
        </addColumn>
    </changeSet>

    <changeSet id="20190606 v18 cached_url_view" author="Migrated From Flyway">
        <dropTable tableName="cached_url" />
        <createView viewName="cached_url">
            WITH RECURSIVE tree (id, public_id, name, parent_public_id, level, is_primary, path) AS (
                SELECT
                  contexts.id,
                  contexts.public_id,
                  contexts.name,
                  cast(NULL AS VARCHAR)                AS parent_public_id,
                  0                                    AS level,
                  TRUE                                 AS is_primary,
                  '/' || substr(contexts.public_id, 5) AS path
                FROM
                  (
                    SELECT
                      id,
                      public_id,
                      name
                    FROM subject

                    UNION ALL

                    SELECT
                      id,
                      public_id,
                      name
                    FROM topic
                    WHERE context = TRUE
                  ) contexts

                UNION ALL

                SELECT
                  child.id,
                  child.public_id,
                  child.name,
                  parent.public_id                       AS parent_public_id,
                  parent.level + 1                       AS level,
                  child.is_primary AND parent.is_primary AS is_primary,
                  parent.path || '/' || substr(child.public_id, 5)
                FROM
                  (
                    SELECT
                      r.id,
                      r.public_id,
                      t.public_id   AS parent_public_id,
                      r.name,
                      tr.is_primary AS is_primary
                    FROM
                      resource r
                      INNER JOIN topic_resource tr ON tr.resource_id = r.id
                      INNER JOIN topic t ON tr.topic_id = t.id

                    UNION ALL

                    SELECT
                      st.id,
                      st.public_id,
                      t.public_id    AS parent_public_id,
                      st.name,
                      tst.is_primary AS is_primary
                    FROM topic t
                      INNER JOIN topic_subtopic tst ON t.id = tst.topic_id
                      INNER JOIN topic st ON tst.subtopic_id = st.id

                    UNION ALL

                    SELECT
                      t.id,
                      t.public_id,
                      s.public_id   AS parent_public_id,
                      t.name,
                      st.is_primary AS is_primary
                    FROM
                      subject s
                      INNER JOIN subject_topic st ON s.id = st.subject_id
                      INNER JOIN topic t ON st.topic_id = t.id
                  ) child
                  INNER JOIN tree AS parent ON parent.public_id = child.parent_public_id
                WHERE 1 = 1
              )

              SELECT
                id,
                public_id,
                path,
                is_primary
              FROM
                tree t
        </createView>
    </changeSet>

    <changeSet id="20190606 v19 cached_url view with parent" author="Migrated From Flyway">
        <createView viewName="cached_url" replaceIfExists="true">
            WITH RECURSIVE tree (id, public_id, name, parent_public_id, level, is_primary, path) AS (
              SELECT
              contexts.id,
              contexts.public_id,
              contexts.name,
              cast(NULL AS VARCHAR) AS parent_public_id,
              0 AS level,
              TRUE AS is_primary,
              '/' || substr(contexts.public_id, 5) AS path
              FROM
            (
              SELECT
              id,
              public_id,
              name
              FROM subject

              UNION ALL

              SELECT
              id,
              public_id,
              name
              FROM topic
              WHERE context = TRUE
            ) contexts

              UNION ALL

              SELECT
              child.id,
              child.public_id,
              child.name,
              parent.public_id AS parent_public_id,
              parent.level + 1 AS level,
              child.is_primary AND parent.is_primary AS is_primary,
              parent.path || '/' || substr(child.public_id, 5)
              FROM
            (
              SELECT
              r.id,
              r.public_id,
              t.public_id AS parent_public_id,
              r.name,
              tr.is_primary AS is_primary
              FROM
              resource r
              INNER JOIN topic_resource tr ON tr.resource_id = r.id
              INNER JOIN topic t ON tr.topic_id = t.id

              UNION ALL

              SELECT
              st.id,
              st.public_id,
              t.public_id AS parent_public_id,
              st.name,
              tst.is_primary AS is_primary
              FROM topic t
              INNER JOIN topic_subtopic tst ON t.id = tst.topic_id
              INNER JOIN topic st ON tst.subtopic_id = st.id

              UNION ALL

              SELECT
              t.id,
              t.public_id,
              s.public_id AS parent_public_id,
              t.name,
              st.is_primary AS is_primary
              FROM
              subject s
              INNER JOIN subject_topic st ON s.id = st.subject_id
              INNER JOIN topic t ON st.topic_id = t.id
            ) child
              INNER JOIN tree AS parent ON parent.public_id = child.parent_public_id
              WHERE 1 = 1
            )

              SELECT
              id,
              public_id,
              path,
              is_primary,
              parent_public_id
              FROM
              tree t
        </createView>
    </changeSet>

    <changeSet id="20190606 v20 url_map" author="Migrated From Flyway">
        <createTable tableName="URL_MAP">
            <column name="OLD_URL" type="varchar(255)"><constraints primaryKey="true" /></column>
            <column name="PUBLIC_ID" type="varchar(255)"><constraints nullable="false" /></column>
            <column name="SUBJECT_ID" type="varchar(255)" />
        </createTable>
    </changeSet>
    
    <changeSet id="20190606 v21 RecanonifyUrlMap" author="Migrated From Flyway">
        <customChange class="no.ndla.taxonomy.migration.V21__RecanonifyUrlMap" />
    </changeSet>

    <changeSet id="20190606 v22 cached_url materialized view" author="Migrated From Flyway">
        <sql>
            DROP view cached_url;

            CREATE MATERIALIZED VIEW cached_url as (
            WITH RECURSIVE tree (id, public_id, name, parent_public_id, level, is_primary, path) AS (
            SELECT
            contexts.id,
            contexts.public_id,
            contexts.name,
            cast(NULL AS VARCHAR) AS parent_public_id,
              0 AS level,
              TRUE AS is_primary,
              '/' || substr(contexts.public_id, 5) AS path
              FROM
            (
              SELECT
              id,
              public_id,
              name
              FROM subject

              UNION ALL

              SELECT
              id,
              public_id,
              name
              FROM topic
              WHERE context = TRUE
            ) contexts

              UNION ALL

              SELECT
              child.id,
              child.public_id,
              child.name,
              parent.public_id AS parent_public_id,
              parent.level + 1 AS level,
              child.is_primary AND parent.is_primary AS is_primary,
              parent.path || '/' || substr(child.public_id, 5)
              FROM
            (
              SELECT
              r.id,
              r.public_id,
              t.public_id AS parent_public_id,
              r.name,
              tr.is_primary AS is_primary
              FROM
              resource r
              INNER JOIN topic_resource tr ON tr.resource_id = r.id
              INNER JOIN topic t ON tr.topic_id = t.id

              UNION ALL

              SELECT
              st.id,
              st.public_id,
              t.public_id AS parent_public_id,
              st.name,
              tst.is_primary AS is_primary
              FROM topic t
              INNER JOIN topic_subtopic tst ON t.id = tst.topic_id
              INNER JOIN topic st ON tst.subtopic_id = st.id

              UNION ALL

              SELECT
              t.id,
              t.public_id,
              s.public_id AS parent_public_id,
              t.name,
              st.is_primary AS is_primary
              FROM
              subject s
              INNER JOIN subject_topic st ON s.id = st.subject_id
              INNER JOIN topic t ON st.topic_id = t.id
            ) child
              INNER JOIN tree AS parent ON parent.public_id = child.parent_public_id
              WHERE 1 = 1
            )

              SELECT
              id,
              public_id,
              path,
              is_primary,
              parent_public_id
              FROM
              tree t
            );
        </sql>
        <sql>
            CREATE UNIQUE INDEX cached_url_path_idx ON cached_url (path);
        </sql>
        <sql>
            CREATE INDEX cached_url_public_id_idx ON cached_url (public_id);
        </sql>
    </changeSet>

    <changeSet id="20190606 v23 modification triggers" author="Migrated From Flyway">
        <sql splitStatements="false" stripComments="false">
            drop function if exists update_url_cache() cascade;
        </sql>
        <sql splitStatements="false" stripComments="false">
            CREATE OR REPLACE FUNCTION update_url_cache()
            RETURNS trigger LANGUAGE plpgsql
            AS
            $function$
            begin
            REFRESH MATERIALIZED VIEW CONCURRENTLY cached_url;
              RETURN NULL;
            end;
            $function$
        </sql>
        <sql splitStatements="false" stripComments="false">

            create trigger refresh_paths
              after insert or update or delete or truncate
              on subject
            execute procedure update_url_cache();

            create trigger refresh_paths
              after insert or update or delete or truncate
              on topic
            execute procedure update_url_cache();

            create trigger refresh_paths
              after insert or update or delete or truncate
              on resource
            execute procedure update_url_cache();

            create trigger refresh_paths
              after insert or update or delete or truncate
              on subject_topic
            execute procedure update_url_cache();

            create trigger refresh_paths
              after insert or update or delete or truncate
              on topic_subtopic
            execute procedure update_url_cache();

            create trigger refresh_paths
            after insert or update or delete or truncate
            on topic_resource
            execute procedure update_url_cache();
        </sql>
    </changeSet>
    <changeSet id="20190606 fix unique constraint for topic_subtopic set on the wrong table (remove index)"
               author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="subject_topic" indexName="topic_subtopic_unique"/>
        </preConditions>

        <dropUniqueConstraint tableName="subject_topic" constraintName="topic_subtopic_unique"
                              uniqueColumns="topic_id,subject_id"/>
    </changeSet>

    <changeSet id="20190606 fix unique constraint for topic_subtopic set on the wrong table (create index)"
               author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists tableName="topic_subtopic" indexName="topic_subtopic_unique"/>
            </not>
        </preConditions>

        <addUniqueConstraint tableName="topic_subtopic" columnNames="topic_id,subtopic_id"
                             constraintName="topic_subtopic_unique"/>
    </changeSet>

    <changeSet id="20190606 rename foreign keys on table resource_resource_type (1/2 resource_type_resource_id_fkey)" author="Jon-Eirik Pettersen">
        <!-- Got the wrong name from migration, only applies if running liquibase on clean database -->
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="resource_type_resource_id_fkey" foreignKeyTableName="resource_resource_type"/>
        </preConditions>
        <dropForeignKeyConstraint baseTableName="resource_resource_type" constraintName="resource_type_resource_id_fkey" />
        <addForeignKeyConstraint baseTableName="resource_resource_type" baseColumnNames="resource_id" constraintName="resource_resource_type_resource_id_fkey" referencedTableName="resource"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet id="20190606 rename foreign keys on table resource_resource_type (2/2 resource_type_resource_type_id_fkey)" author="Jon-Eirik Pettersen">
        <!-- Got the wrong name from migration, only applies if running liquibase on clean database -->
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="resource_type_resource_type_id_fkey" foreignKeyTableName="resource_resource_type"/>
        </preConditions>
        <dropForeignKeyConstraint baseTableName="resource_resource_type" constraintName="resource_type_resource_type_id_fkey" />
        <addForeignKeyConstraint baseTableName="resource_resource_type" baseColumnNames="resource_type_id" constraintName="resource_resource_type_resource_type_id_fkey" referencedTableName="resource_type"
                                 referencedColumnNames="id" />
    </changeSet>

    <!-- Replace unique indices with unique constraints to sync original created with liquibase created -->
    <!-- applies only to database created with flyway -->

    <changeSet id="20190606 replace unique index with constraint on filter" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="filter" indexName="filter_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                    FROM information_schema.table_constraints
                    WHERE constraint_name ='filter_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'filter'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="filter" indexName="filter_public_id" />
        <addUniqueConstraint tableName="filter" columnNames="public_id" constraintName="filter_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on relevance" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="relevance" indexName="relevance_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='relevance_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'relevance'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="relevance" indexName="relevance_public_id" />
        <addUniqueConstraint tableName="relevance" columnNames="public_id" constraintName="relevance_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on relevance_translation" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="relevance_translation" indexName="relevance_language_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='relevance_language_unique' AND constraint_type = 'UNIQUE' AND table_name = 'relevance_translation'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="relevance_translation" indexName="relevance_language_unique" />
        <addUniqueConstraint tableName="relevance_translation" columnNames="relevance_id,language_code" constraintName="relevance_language_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource" indexName="resource_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'resource'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource" indexName="resource_public_id" />
        <addUniqueConstraint tableName="resource" columnNames="public_id" constraintName="resource_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource_filter 1/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource_filter" indexName="resource_filter_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_filter_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'resource_filter'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource_filter" indexName="resource_filter_public_id" />
        <addUniqueConstraint tableName="resource_filter" columnNames="public_id" constraintName="resource_filter_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource_filter 2/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource_filter" indexName="resource_filter_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_filter_unique' AND constraint_type = 'UNIQUE' AND table_name = 'resource_filter'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource_filter" indexName="resource_filter_unique" />
        <addUniqueConstraint tableName="resource_filter" columnNames="filter_id,resource_id" constraintName="resource_filter_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource_resource_type 1/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource_resource_type" indexName="resource_resource_type_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_resource_type_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'resource_resource_type'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource_resource_type" indexName="resource_resource_type_public_id" />
        <addUniqueConstraint tableName="resource_resource_type" columnNames="public_id" constraintName="resource_resource_type_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource_resource_type 2/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource_resource_type" indexName="resource_resource_type_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_resource_type_unique' AND constraint_type = 'UNIQUE' AND table_name = 'resource_resource_type'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource_resource_type" indexName="resource_resource_type_unique" />
        <addUniqueConstraint tableName="resource_resource_type" columnNames="resource_id,resource_type_id" constraintName="resource_resource_type_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource_translation" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource_translation" indexName="resource_language_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_language_unique' AND constraint_type = 'UNIQUE' AND table_name = 'resource_translation'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource_translation" indexName="resource_language_unique" />
        <addUniqueConstraint tableName="resource_translation" columnNames="resource_id,language_code" constraintName="resource_language_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource_type" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource_type" indexName="resource_type_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_type_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'resource_type'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource_type" indexName="resource_type_public_id" />
        <addUniqueConstraint tableName="resource_type" columnNames="public_id" constraintName="resource_type_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on resource_type_translation" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="resource_type_translation" indexName="resource_type_language_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='resource_type_language_unique' AND constraint_type = 'UNIQUE' AND table_name = 'resource_type_translation'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="resource_type_translation" indexName="resource_type_language_unique" />
        <addUniqueConstraint tableName="resource_type_translation" columnNames="resource_type_id,language_code" constraintName="resource_type_language_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on subject" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="subject" indexName="subject_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='subject_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'subject'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="subject" indexName="subject_public_id" />
        <addUniqueConstraint tableName="subject" columnNames="public_id" constraintName="subject_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on subject_topic 1/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="subject_topic" indexName="subject_topic_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='subject_topic_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'subject_topic'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="subject_topic" indexName="subject_topic_public_id" />
        <addUniqueConstraint tableName="subject_topic" columnNames="public_id" constraintName="subject_topic_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on subject_topic 2/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="subject_topic" indexName="subject_topic_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='subject_topic_unique' AND constraint_type = 'UNIQUE' AND table_name = 'subject_topic'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="subject_topic" indexName="subject_topic_unique" />
        <addUniqueConstraint tableName="subject_topic" columnNames="topic_id,subject_id" constraintName="subject_topic_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on subject_translation" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="subject_translation" indexName="subject_language_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='subject_language_unique' AND constraint_type = 'UNIQUE' AND table_name = 'subject_translation'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="subject_translation" indexName="subject_language_unique" />
        <addUniqueConstraint tableName="subject_translation" columnNames="subject_id,language_code" constraintName="subject_language_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic" indexName="topic_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'topic'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic" indexName="topic_public_id" />
        <addUniqueConstraint tableName="topic" columnNames="public_id" constraintName="topic_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic_filter 1/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic_filter" indexName="topic_filter_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_filter_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'topic_filter'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic_filter" indexName="topic_filter_public_id" />
        <addUniqueConstraint tableName="topic_filter" columnNames="public_id" constraintName="topic_filter_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic_filter 2/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic_filter" indexName="topic_filter_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_filter_unique' AND constraint_type = 'UNIQUE' AND table_name = 'topic_filter'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic_filter" indexName="topic_filter_unique" />
        <addUniqueConstraint tableName="topic_filter" columnNames="filter_id,topic_id" constraintName="topic_filter_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic_resource 1/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic_resource" indexName="topic_resource_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_resource_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'topic_resource'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic_resource" indexName="topic_resource_public_id" />
        <addUniqueConstraint tableName="topic_resource" columnNames="public_id" constraintName="topic_resource_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic_resource 2/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic_resource" indexName="topic_resource_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_resource_unique' AND constraint_type = 'UNIQUE' AND table_name = 'topic_resource'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic_resource" indexName="topic_resource_unique" />
        <addUniqueConstraint tableName="topic_resource" columnNames="topic_id,resource_id" constraintName="topic_resource_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic_subtopic 1/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic_subtopic" indexName="topic_subtopic_public_id" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_subtopic_public_id' AND constraint_type = 'UNIQUE' AND table_name = 'topic_subtopic'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic_subtopic" indexName="topic_subtopic_public_id" />
        <addUniqueConstraint tableName="topic_subtopic" columnNames="public_id" constraintName="topic_subtopic_public_id" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic_subtopic 2/2" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic_subtopic" indexName="topic_subtopic_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_subtopic_unique' AND constraint_type = 'UNIQUE' AND table_name = 'topic_subtopic'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic_subtopic" indexName="topic_subtopic_unique" />
        <addUniqueConstraint tableName="topic_subtopic" columnNames="topic_id,subtopic_id" constraintName="topic_subtopic_unique" />
    </changeSet>

    <changeSet id="20190606 replace unique index with constraint on topic_translation" author="Jon-Eirik Pettersen">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="topic_translation" indexName="topic_language_unique" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.table_constraints
                WHERE constraint_name ='topic_language_unique' AND constraint_type = 'UNIQUE' AND table_name = 'topic_translation'
            </sqlCheck>
        </preConditions>
        <dropIndex tableName="topic_translation" indexName="topic_language_unique" />
        <addUniqueConstraint tableName="topic_translation" columnNames="topic_id,language_code" constraintName="topic_language_unique" />
    </changeSet>
</databaseChangeLog>